<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸°ì—…ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            height: 100vh;
            color: white;
            overflow: hidden;
        }

        .split-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .left-panel {
            flex: 1;
            min-width: 300px;
            overflow-y: auto;
            padding: 20px;
            background: inherit;
        }

        .resizer {
            width: 8px;
            background: rgba(255, 255, 255, 0.1);
            cursor: col-resize;
            position: relative;
            transition: background 0.2s ease;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .resizer:hover {
            background: rgba(0, 212, 255, 0.3);
        }

        .resizer::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .right-panel {
            flex: 1;
            min-width: 300px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
        }

        /* ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .ai-badge {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .company-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #ffffff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .analysis-period {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-bottom: 25px;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 4px;
        }

        .metric-change {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 500;
        }

        .change-positive {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .change-negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .chart-section {
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #00d4ff;
        }

        .chart-container {
            position: relative;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .news-section {
            margin-top: 20px;
        }

        .news-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .news-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-positive { border-left: 3px solid #22c55e; }
        .stat-neutral { border-left: 3px solid #64748b; }
        .stat-negative { border-left: 3px solid #ef4444; }

        .news-articles {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        .news-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .news-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: #00d4ff;
            line-height: 1.3;
        }

        .news-summary {
            font-size: 0.75rem;
            line-height: 1.4;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* ì±„íŒ… ìŠ¤íƒ€ì¼ */
        .chat-header {
            background: transparent;
            padding: 40px 20px 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .chat-title {
            color: white;
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: transparent;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 0;
        }

        .messages-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            flex-shrink: 0;
            background: white;
            color: #1e3c72;
        }

        .message.assistant .message-avatar {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 20px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .message.user .message-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message.assistant .message-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .chat-input-container {
            padding: 30px 20px 40px 20px;
            background: transparent;
            border: none;
            display: flex;
            gap: 12px;
            align-items: flex-end;
            justify-content: center;
        }

        .input-wrapper {
            position: relative;
            flex: 1;
            max-width: 600px;
        }

        .chat-input {
            width: 100%;
            background: transparent;
            border: 2px solid #00d4ff;
            border-radius: 25px;
            padding: 16px 60px 16px 20px;
            color: white;
            font-size: 1rem;
            resize: none;
            min-height: 20px;
            max-height: 120px;
            outline: none;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #00d4ff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-button:hover {
            background: #0099cc;
            transform: translateY(-50%) scale(1.05);
        }

        .send-button:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1rem;
        }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #00d4ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #ff6b6b;
            text-align: center;
        }

        @media (max-width: 768px) {
            .split-container {
                flex-direction: column;
            }
            
            .resizer {
                display: none;
            }
            
            .left-panel, .right-panel {
                min-width: unset;
                height: 50vh;
            }
            
            .company-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="split-container">
        <!-- ì™¼ìª½ íŒ¨ë„: ëŒ€ì‹œë³´ë“œ -->
        <div class="left-panel">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>

            <div id="error" class="error-message" style="display: none;">
                <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
            </div>

            <div id="dashboard" style="display: none;">
                <div class="header">
                    <div class="ai-badge">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</div>
                    <h1 class="company-title" id="companyName">-</h1>
                    <p class="analysis-period" id="analysisPeriod">-</p>
                </div>

                <!-- ì¬ë¬´ ì§€í‘œ ì¹´ë“œ -->
                <div class="financial-grid">
                    <div class="metric-card">
                        <div class="metric-label">ë§¤ì¶œì•¡</div>
                        <div class="metric-value" id="revenue">-</div>
                        <div class="metric-change" id="revenueChange">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">ì˜ì—…ì´ìµ</div>
                        <div class="metric-value" id="operatingProfit">-</div>
                        <div class="metric-change" id="operatingChange">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">ìˆœì´ìµ</div>
                        <div class="metric-value" id="netProfit">-</div>
                        <div class="metric-change" id="netChange">-</div>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ -->
                <div class="chart-section">
                    <h3 class="chart-title">ğŸ“ˆ ë§¤ì¶œ ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <div class="chart-section">
                    <h3 class="chart-title">ğŸ’° ìˆ˜ìµì„± ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>

                <!-- ë‰´ìŠ¤ ì„¹ì…˜ -->
                <div class="news-section">
                    <h3 class="chart-title">ğŸ“° ìµœì‹  ë‰´ìŠ¤</h3>
                    <div class="news-stats" id="newsStats">
                        <!-- ë‰´ìŠ¤ í†µê³„ -->
                    </div>
                    <div class="news-articles" id="newsArticles">
                        <!-- ë‰´ìŠ¤ ê¸°ì‚¬ë“¤ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¦¬ì‚¬ì´ì € -->
        <div class="resizer"></div>

        <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ì±„íŒ… -->
        <div class="right-panel">
            <div class="chat-header">
                <h1 class="chat-title">ì•„ë¬´ê±°ë‚˜ ì§ˆë¬¸í•´ë³´ì„¸ìš”!</h1>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="messages-container" id="messagesContainer">
                    <div class="message assistant">
                        <div class="message-avatar">AI</div>
                        <div class="message-content">
                            ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” AI ì¬ë¬´ë¶„ì„ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ğŸ¯<br><br>
                            ì™¼ìª½ ëŒ€ì‹œë³´ë“œì—ì„œ ê¸°ì—…ì„ ì„ íƒí•˜ì‹œê±°ë‚˜, ê¶ê¸ˆí•œ ê¸°ì—…ëª…ì„ ë§ì”€í•´ì£¼ì‹œë©´ ìƒì„¸í•œ ì¬ë¬´ ë¶„ì„ì„ ë„ì™€ë“œë¦´ê²Œìš”!<br><br>
                            ì˜ˆì‹œ:<br>
                            â€¢ "ì‚¼ì„±ì „ì ë¶„ì„í•´ì¤˜"<br>
                            â€¢ "ì• í”Œ ì£¼ê°€ ì–´ë–¤ê°€ìš”?"<br>
                            â€¢ "íˆ¬ì ì¡°ì–¸ ë¶€íƒí•´ìš”"
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="í•˜íƒœì§€ì™€ ì—ì´ì•„ì´ë“¤ì—ê²Œ ë¬¼ì–´ë³´ê¸°"
                        rows="1"></textarea>
                    <button id="sendButton" class="send-button">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”§ Flask ì„œë²„ ì—°ë™ ì„¤ì •
        const API_BASE_URL = 'http://localhost:5001'; // Flask ì„œë²„ ì£¼ì†Œ (í•„ìš”ì‹œ ìˆ˜ì •)
        let currentDashboardData = null; // í˜„ì¬ ëŒ€ì‹œë³´ë“œ ë°ì´í„°
        let revenueChart = null;
        let profitChart = null;

        // ğŸ”§ API í˜¸ì¶œ í•¨ìˆ˜
        async function fetchDashboardData(corpCode, startYear = '2020', endYear = '2023') {
            try {
                console.log(`ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìš”ì²­: ${corpCode} (${startYear}-${endYear})`);
                
                const requestData = {
                    corp_code: corpCode,
                    bgn_de: startYear,
                    end_de: endYear,
                    user_sno: 'web_user',
                    nickname: 'ì›¹ì‚¬ìš©ì',
                    difficulty: 'intermediate',
                    interest: 'ê¸°ìˆ ì£¼',
                    purpose: 'íˆ¬ìë¶„ì„'
                };

                const response = await fetch(`${API_BASE_URL}/api/dashboard`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìˆ˜ì‹ :', data);
                return data;

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        async function sendChatMessage(message) {
            try {
                const requestData = {
                    user_sno: 'web_user',
                    nickname: 'ì›¹ì‚¬ìš©ì',
                    difficulty: 'intermediate',
                    interest: 'ê¸°ìˆ ì£¼',
                    purpose: 'íˆ¬ìë¶„ì„',
                    chat_type: currentDashboardData ? 'company_analysis' : 'general_chat',
                    message: message
                };

                // ëŒ€ì‹œë³´ë“œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì»¨í…ìŠ¤íŠ¸ë¡œ ì „ë‹¬
                if (currentDashboardData) {
                    requestData.company_data = currentDashboardData;
                }

                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.response;

            } catch (error) {
                console.error('ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                return `ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${error.message})`;
            }
        }

        // ğŸ”§ UI í—¬í¼ í•¨ìˆ˜ë“¤
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('error').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            hideLoading();
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // ğŸ”§ í•œêµ­ ì›í™” í¬ë§·íŒ…
        function formatKoreanWon(amount) {
            if (!amount) return '0ì›';
            const trillion = Math.floor(amount / 1000000000000);
            const billion = Math.floor((amount % 1000000000000) / 100000000);
            let result = '';
            if (trillion > 0) result += `${trillion}ì¡°`;
            if (billion > 0) result += `${billion}ì–µì›`;
            if (result === '') result = '0ì›';
            return result;
        }

        function calculateChange(current, previous) {
            if (!previous || previous === 0) return { rate: 0, isPositive: true };
            const change = ((current - previous) / previous) * 100;
            return { rate: Math.abs(change).toFixed(1), isPositive: change >= 0 };
        }

        // ğŸ”§ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤
        function createRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.yearly_trends.years,
                    datasets: [{
                        label: 'ë§¤ì¶œì•¡',
                        data: data.yearly_trends.revenue.map(v => v / 1000000000000),
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#00d4ff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 1,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                callback: function(value) { return value + 'ì¡°'; }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function createProfitChart(data) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ
            if (profitChart) {
                profitChart.destroy();
            }
            
            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.yearly_trends.years,
                    datasets: [
                        {
                            label: 'ì˜ì—…ì´ìµ',
                            data: data.yearly_trends.operating_profit.map(v => v / 1000000000000),
                            backgroundColor: 'rgba(0, 212, 255, 0.8)',
                            borderRadius: 4
                        },
                        {
                            label: 'ìˆœì´ìµ',
                            data: data.yearly_trends.net_profit.map(v => v / 1000000000000),
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'rgba(255, 255, 255, 0.8)', font: { size: 10 } } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                callback: function(value) { return value + 'ì¡°'; }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // ğŸ”§ ëŒ€ì‹œë³´ë“œ ë Œë”ë§ í•¨ìˆ˜
        function renderDashboard(data) {
            try {
                // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
                document.getElementById('companyName').textContent = data.company_info.corp_name;
                document.getElementById('analysisPeriod').textContent = `ë¶„ì„ê¸°ê°„: ${data.company_info.analysis_period}`;

                const trends = data.yearly_trends;
                const currentYear = trends.years.length - 1;
                const prevYear = currentYear - 1;

                // ë§¤ì¶œì•¡
                document.getElementById('revenue').textContent = formatKoreanWon(data.financial_summary.revenue);
                if (prevYear >= 0) {
                    const revenueChange = calculateChange(trends.revenue[currentYear], trends.revenue[prevYear]);
                    const revenueChangeEl = document.getElementById('revenueChange');
                    revenueChangeEl.textContent = `${revenueChange.isPositive ? '+' : '-'}${revenueChange.rate}%`;
                    revenueChangeEl.className = `metric-change ${revenueChange.isPositive ? 'change-positive' : 'change-negative'}`;
                }

                // ì˜ì—…ì´ìµ
                document.getElementById('operatingProfit').textContent = formatKoreanWon(data.financial_summary.operating_profit);
                if (prevYear >= 0) {
                    const operatingChange = calculateChange(trends.operating_profit[currentYear], trends.operating_profit[prevYear]);
                    const operatingChangeEl = document.getElementById('operatingChange');
                    operatingChangeEl.textContent = `${operatingChange.isPositive ? '+' : '-'}${operatingChange.rate}%`;
                    operatingChangeEl.className = `metric-change ${operatingChange.isPositive ? 'change-positive' : 'change-negative'}`;
                }

                // ìˆœì´ìµ
                document.getElementById('netProfit').textContent = formatKoreanWon(data.financial_summary.net_profit);
                if (prevYear >= 0) {
                    const netChange = calculateChange(trends.net_profit[currentYear], trends.net_profit[prevYear]);
                    const netChangeEl = document.getElementById('netChange');
                    netChangeEl.textContent = `${netChange.isPositive ? '+' : '-'}${netChange.rate}%`;
                    netChangeEl.className = `metric-change ${netChange.isPositive ? 'change-positive' : 'change-negative'}`;
                }

                // ë‰´ìŠ¤ í†µê³„
                const newsStats = document.getElementById('newsStats');
                if (data.news_data.has_news) {
                    newsStats.innerHTML = `
                        <div class="news-stat stat-positive">ê¸ì • ${data.news_data.summary_stats.positive_news}ê±´</div>
                        <div class="news-stat stat-neutral">ì¤‘ë¦½ ${data.news_data.summary_stats.neutral_news}ê±´</div>
                        <div class="news-stat stat-negative">ë¶€ì • ${data.news_data.summary_stats.negative_news}ê±´</div>
                    `;
                } else {
                    newsStats.innerHTML = '<div class="news-stat">ë‰´ìŠ¤ ì—†ìŒ</div>';
                }

                // ë‰´ìŠ¤ ê¸°ì‚¬
                const newsArticles = document.getElementById('newsArticles');
                if (data.news_data.has_news && data.news_data.articles.length > 0) {
                    newsArticles.innerHTML = data.news_data.articles.map(article => `
                        <div class="news-item">
                            <div class="news-title">${article.title}</div>
                            <div class="news-summary">${article.summary}</div>
                            <div class="news-meta">
                                <span>${article.source}</span>
                                <span>${article.published_date}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    newsArticles.innerHTML = '<div class="news-item">ìµœê·¼ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }

                // ì°¨íŠ¸ ìƒì„±
                createRevenueChart(data);
                createProfitChart(data);

                // ë¡œë”© ìˆ¨ê¸°ê³  ëŒ€ì‹œë³´ë“œ í‘œì‹œ
                hideLoading();
                hideError();
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ì‹¤íŒ¨:', error);
                showError(`ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // ğŸŒŸ ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ë©”ì¸ í•¨ìˆ˜
        window.displayDashboard = async function(corpCode, startYear = '2020', endYear = '2023') {
            console.log(`ëŒ€ì‹œë³´ë“œ í‘œì‹œ ìš”ì²­: ${corpCode}`);
            
            showLoading();
            
            try {
                const dashboardData = await fetchDashboardData(corpCode, startYear, endYear);
                currentDashboardData = dashboardData;
                renderDashboard(dashboardData);
                
                console.log('ëŒ€ì‹œë³´ë“œ í‘œì‹œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ í‘œì‹œ ì‹¤íŒ¨:', error);
                showError(`ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        };

        // ğŸ”§ ë¦¬ì‚¬ì´ì € ê¸°ëŠ¥
        let isResizing = false;

        document.querySelector('.resizer').addEventListener('mousedown', function(e) {
            isResizing = true;
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            
            const container = document.querySelector('.split-container');
            const leftPanel = document.querySelector('.left-panel');
            const rightPanel = document.querySelector('.right-panel');
            
            const containerRect = container.getBoundingClientRect();
            const newLeftWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
            
            if (newLeftWidth > 20 && newLeftWidth < 80) {
                leftPanel.style.flex = `0 0 ${newLeftWidth}%`;
                rightPanel.style.flex = `0 0 ${100 - newLeftWidth}%`;
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', stopResize);
        }

        // ğŸ”§ ì±„íŒ… ê¸°ëŠ¥
        const chatMessages = document.getElementById('chatMessages');
        const messagesContainer = document.getElementById('messagesContainer');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');

        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${role === 'user' ? 'í™' : 'AI'}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage('user', message);
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
            sendButton.disabled = true;
            
            // ë¡œë”© ë©”ì‹œì§€
            addMessage('assistant', 'ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”! ğŸ”');
            
            try {
                // Flask ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
                const response = await sendChatMessage(message);
                
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const lastMessage = messagesContainer.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤')) {
                    lastMessage.remove();
                }
                
                // AI ì‘ë‹µ ì¶”ê°€
                addMessage('assistant', response);
                
            } catch (error) {
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const lastMessage = messagesContainer.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤')) {
                    lastMessage.remove();
                }
                
                // ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€
                addMessage('assistant', `ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (${error.message})`);
            } finally {
                // ì „ì†¡ ë²„íŠ¼ í™œì„±í™”
                sendButton.disabled = false;
            }
        }

        sendButton.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í¬ê¸° ì¡°ì •
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // ğŸ”§ ì´ˆê¸°í™” (í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„°)
        const sampleData = {
            "company_info": {
                "analysis_period": "2020-2023",
                "corp_code": "00126380",
                "corp_name": "ì‚¼ì„±ì „ì",
                "latest_year": "2023"
            },
            "financial_summary": {
                "net_profit": 15487100000000,
                "operating_profit": 6566976000000,
                "revenue": 258935494000000,
                "total_assets": 455905980000000,
                "total_debt": 92228115000000,
                "total_equity": 363677865000000
            },
            "news_data": {
                "articles": [
                    {
                        "id": 1,
                        "published_date": "2025-07-31",
                        "source": "ë”ë ‰",
                        "summary": "ì‚¼ì„±ì „ìëŠ” 2025ë…„ 2ë¶„ê¸° ë§¤ì¶œ 74ì¡°5700ì–µì›, ì˜ì—…ì´ìµ 4ì¡°6800ì–µì›ì„ ê¸°ë¡í–ˆë‹¤. ë§¤ì¶œì€ ì „ë…„ ë™ê¸° ëŒ€ë¹„ 0.7% ì¦ê°€í–ˆìœ¼ë‚˜, ì˜ì—…ì´ìµì€ 55.2% ê°ì†Œí–ˆë‹¤.",
                        "title": "ì‚¼ì„±ì „ì 2025ë…„ 2ë¶„ê¸° ì‹¤ì ë°œí‘œ ì»¨í¼ëŸ°ìŠ¤ì½œ ì „ë¬¸"
                    },
                    {
                        "id": 2,
                        "published_date": "2025-07-07",
                        "source": "ë‰´ìŠ¤1",
                        "summary": "ì‚¼ì„±ì „ì ì£¼ê°€ëŠ” 2ë¶„ê¸° ì‹¤ì  ë°œí‘œë¥¼ ì•ë‘ê³  1.42% í•˜ë½í–ˆë‹¤. íˆ¬ììë“¤ì€ ì‹¤ì ì— ëŒ€í•œ ë¶ˆí™•ì‹¤ì„±ìœ¼ë¡œ ë§¤ë„ì„¸ë¥¼ ë³´ì˜€ë‹¤.",
                        "title": "ì‚¼ì„±ì „ì, 2ë¶„ê¸° ì‹¤ì  ë°œí‘œ ì•ë‘ê³  1%ëŒ€ í•˜ë½[í•«ì¢…ëª©]"
                    },
                    {
                        "id": 3,
                        "published_date": "2025-07-10",
                        "source": "ì¤Œì¸ë² ìŠ¤íŠ¸",
                        "summary": "ì‚¼ì„±ì „ì ì£¼ê°€ëŠ” ì• í”Œê³¼ì˜ ì¹© ìˆ˜ì£¼ ì†Œì‹ìœ¼ë¡œ 1.84% ìƒìŠ¹í–ˆë‹¤. 2ë¶„ê¸° ì‹¤ì  ê°œì„  ê¸°ëŒ€ê°ì´ íˆ¬ì ì‹¬ë¦¬ì— ê¸ì •ì ìœ¼ë¡œ ì‘ìš©í–ˆë‹¤.",
                        "title": "ì‚¼ì„±ì „ì, ì• í”Œê³¼ì˜ ì¹© ìˆ˜ì£¼ ì†Œì‹ì— 1.84% ìƒìŠ¹"
                    }
                ],
                "has_news": true,
                "summary_stats": {
                    "negative_news": 1,
                    "neutral_news": 1,
                    "positive_news": 1
                },
                "total_articles": 3
            },
            "yearly_trends": {
                "net_profit": [26407832000000, 39907450000000, 55654077000000, 15487100000000],
                "operating_profit": [35993876000000, 51633856000000, 43376630000000, 6566976000000],
                "revenue": [236806988000000, 279604799000000, 302231360000000, 258935494000000],
                "years": ["2020", "2021", "2022", "2023"]
            }
        };

        // ğŸš€ í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‹œì—° (ê°œë°œìš©)
        window.addEventListener('load', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‹œì—°');
            setTimeout(() => {
                currentDashboardData = sampleData;
                renderDashboard(sampleData);
                console.log('ìƒ˜í”Œ ëŒ€ì‹œë³´ë“œ í‘œì‹œ ì™„ë£Œ');
            }, 1500);
        });

        // ğŸŒŸ ë””ë²„ê¹…ìš© í—¬í¼ í•¨ìˆ˜ë“¤ (ê°œë°œ ì¤‘ ì½˜ì†”ì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)
        window.testDashboard = function(corpCode = '00126380') {
            console.log(`í…ŒìŠ¤íŠ¸: ${corpCode} ëŒ€ì‹œë³´ë“œ í‘œì‹œ`);
            displayDashboard(corpCode);
        };

        window.testChat = function(message = 'ì´ íšŒì‚¬ ì–´ë–¤ê°€ìš”?') {
            console.log(`í…ŒìŠ¤íŠ¸ ì±„íŒ…: ${message}`);
            addMessage('user', message);
            sendChatMessage(message).then(response => {
                addMessage('assistant', response);
            }).catch(error => {
                addMessage('assistant', `í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            });
        };

        console.log('ğŸ”§ Flask ì—°ë™ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ');
        console.log('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ë“¤:');
        console.log('  - displayDashboard(corpCode, startYear, endYear): ëŒ€ì‹œë³´ë“œ í‘œì‹œ');
        console.log('  - testDashboard(corpCode): í…ŒìŠ¤íŠ¸ìš© ëŒ€ì‹œë³´ë“œ í‘œì‹œ');
        console.log('  - testChat(message): í…ŒìŠ¤íŠ¸ìš© ì±„íŒ…');
        console.log(`ğŸŒ Flask ì„œë²„: ${API_BASE_URL}`);
    </script>
</body>
</html>